<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Eiffel RemRem Publish Service : ">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Eiffel RemRem Publish Service</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/Ericsson/eiffel-remrem-publish">View on GitHub</a>

          <h1 id="project_title">Eiffel RemRem Publish Service</h1>
          <h2 id="project_tagline"></h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/Ericsson/eiffel-remrem-publish/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/Ericsson/eiffel-remrem-publish/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <p>REMReM (REST Mailbox for Registered Messages) is a set of tools that can be used to generate validated Eiffel messages and publish them on a RabbitMQ message bus. They can be run as micro services or as stand-alone CLI versions. For more details on the micro services and the REMReM design, see <a href="https://github.com/Ericsson/eiffel-remrem">https://github.com/Ericsson/eiffel-remrem</a></p>

<h1>
<a id="remrem-publish" class="anchor" href="#remrem-publish" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>RemRem Publish</h1>

<hr>

<h2>
<a id="compatibility" class="anchor" href="#compatibility" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Compatibility</h2>

<ul>
<li>JDK 8</li>
<li>Tomcat 7</li>
</ul>

<hr>

<h2>
<a id="how-to-install" class="anchor" href="#how-to-install" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How to Install?</h2>

<p>Binary is relased via <a href="https://jitpack.io/#Ericsson/eiffel-remrem-publish/">jitPack</a></p>

<p>RemRem Publish in this repository is licensed under the <a href="https://raw.githubusercontent.com/ericsson/eiffel-remrem-publish/master/LICENSE">Apache License 2.0</a>.</p>

<hr>

<h2>
<a id="usage-cli-command-line-interface" class="anchor" href="#usage-cli-command-line-interface" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage CLI (Command Line Interface)</h2>

<pre>$ java -jar publish.war -h
You passed help flag.
usage: java -jar
 -d,--debug                     enable debug traces
 -domain,--domainId &lt;arg&gt;       identifies the domain that produces the event.
 -en,--exchange_name &lt;arg&gt;      exchange name, default is amq.direct
 -f,--content_file &lt;arg&gt;        event content file
 -h,--help                      show help.
 -json,--json_content &lt;arg&gt;     event content in json string. The value can
                                also be a dash(-) and the json will be read
                                from the output of other programs if piped. Multiple
                                json events are also supported.
 -tls,--tls &lt;arg&gt;               tls version, specify a valid tls version: '1', '1.1',
                                '1.2' or default
 -mb,--message_bus &lt;arg&gt;        host of message bus to use, default is
                                127.0.0.1
 -np,--non_persistent           remove persistence from message sending
 -port,--port &lt;arg&gt;             port to connect to message bus
 -ud,--user_domain_suffix &lt;arg&gt; user domain suffix
 -mp,--message_protocol &lt;arg&gt;   name of messaging protocol to be used, e.g. eiffel3,
                                eiffelsemantics, default is eiffelsemantics</pre>

<p>For publish we have input only from file that can contain one or more messages in a json array (surrounded with square brackets) separated by comma. </p>

<p>The routing key is generated based on the event type and given configurations.<br>
   The routing key format is : <br> 
      &lt;protocol&gt;.&lt;family&gt;.&lt;type&gt;.&lt;tag&gt;.&lt;domain&gt; 
   <ul>
      <li>&lt;protocol&gt; is used if provided by the protocol library used. </li>
      <li>&lt;family&gt; and &lt;type&gt; are provided by the protocol library. </li>
      <li>&lt;tag&gt; is defaulted to the value 'notag'. </li>
      <li>&lt;domain&gt; is configured and can be suffixed by a user domain part that the user can specify with -ud option. For more information on domain, see <a href="https://github.com/Ericsson/eiffel/blob/master/eiffel-syntax-and-usage/the-meta-object.md#metasourcedomainid">this link</a> .</li>
   </ul></p>

<p><strong>Publish on a given host, given exchange, given domain and given user domain suffix:</strong></p>

<pre><code> $ java -jar publish.war -f publishMessages.json -en rabbit -mb mb101 -domain eiffel001 -ud fem001 -mp eiffelsemantics
</code></pre>

<p><strong>If you want to have the message non persistent add np flag:</strong></p>

<pre><code> $ java -jar publish.war -f publishMessages.json -en rabbit -mb mb123 -np -mp eiffelsemantics
</code></pre>

<p><strong>If you want to have the message publishing logs add d flag:</strong></p>

<pre><code> $ java -jar publish.war -f publishMessages.json -en rabbit -mb mb123 -mp eiffelsemantics -d
</code></pre>

<h2>
<a id="usage-service" class="anchor" href="#usage-service" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage service</h2>

<p>RemRem Publish microservice allows for sending messages to a topic-based exchange on a RabbitMQ Server. It has an endPoint that must be called using a relative link <code>producer/msg</code>.</p>

<h3>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration</h3>

<p>Configuration parameters will be read from the application.yml file at the root of the classpath at startup.</p>

<p>These parameters need to be provided to start the service:</p>

<ul>
<li><code>rabbitmq.host (String)</code></li>
<li><code>rabbitmq.port (Optional)</code></li>
<li><code>rabbitmq.exchange.name (String)</code></li>
<li><code>rabbitmq.domainId (String)</code></li>
</ul>

<p>An <a href="https://www.rabbitmq.com/tutorials/tutorial-three-java.html">exchange point</a> must exist before you start the service.</p>

<p>For <strong>stand-alone</strong> deployment, the library can be utilized like this:</p>

<pre><code>$ java -Drabbitmq.host=localhost -Drabbitmq.exchange.name=EXCHANGE_NAME -jar eiffel-remrem*
</code></pre>

<p>Active Directory authentication can be enabled for the REMReM REST service by setting the configuration property <code>activedirectory.enabled=true</code>. The necessary configuration properties for Active Directory are</p> 

<ul>
  <li><code>activedirectory.domain=&lt;the domain name, may be empty&gt;</code></li>
  <li><code>activedirectory.url=&lt;LDAP url&gt;</code></li>
</ul>

<p>Each HTTP request must then include an Authorization header with value <code>Basic &lt;Base64 encoded username:password&gt;</code>.</p>

<p>Example Active Directory configuration</p>

<pre><code>$ java -Drabbitmq.host=localhost -Drabbitmq.exchange.name=EXCHANGE_NAME -Dactivedirectory.enabled=true -Dactivedirectory.domain=mycompany -Dactivedirectory.url=ldap://ad.mycompany.com:389 -jar eiffel-remrem*
</code></pre>

<p>To authenticate a user with username "user" and password "secret" the HTTP header <code>Authorization: Basic dXNlcjpzZWNyZXQ=</code> must be included in the request. Where dXNlcjpzZWNyZXQ= is the string user:secret Base64 encoded.</p>

<h3>
<a id="rest-methods" class="anchor" href="#rest-methods" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>REST methods</h3>

<p>The service works on the relative link <code>producer/msg</code> and supports POST requests.</p>

<p>You have to specify a user domain suffix</a> using <code><b>ud</b></code> URL parameter.</p>

<p>You have to specify a messaging protocol using <code><b>mp</b></code> URL parameter.</p>

<p>The request's body must contain a <strong>JSON Object or JSON Array</strong> with the messages.</p>

<hr>

<h2>
<a id="testing" class="anchor" href="#testing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Testing</h2>

<p>You can use command-line tools like <a href="https://en.wikipedia.org/wiki/CURL">curl</a> or some plugin for your favorite browser. For example:</p>

<ul>
<li>
<a href="https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop">Postman</a> for Chromium-based browsers</li>
<li>
<a href="https://addons.mozilla.org/en-US/firefox/addon/httprequester/">HttpRequester</a> for Firefox</li>
</ul>

<h3>
<a id="a-few-examples-with-curl" class="anchor" href="#a-few-examples-with-curl" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>A few examples with <code>curl</code>:</h3>

<p><strong>One message:</strong></p>

<pre><code>$ curl -H "Content-Type: application/json" -X POST -d '["{"data":{"outcome":{"conclusion":"TIMED_OUT","description":"Compilation timed out."},"persistentLogs":[{"name":"firstLog","uri":"http://myHost.com/firstLog"},{"name":"otherLog","uri":"isbn:0-486-27557-4"}]},"links":{"activityExecution":"aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeee1","flowContext":"flowContext","causes":["cause1","cause2"]},"meta":{"domainId":"example.domain","id":"9cdd0f68-df85-44b0-88bd-fc4163ac90a0","type":"eiffelactivityfinished","version":"0.1.7","time":1478780245184,"tags":["tag1","tag2"],"source":{"host":"host","name":"name","uri":"http://java.sun.com/j2se/1.3/","serializer":{"groupId":"G","artifactId":"A","version":"V"}}}}"]' http://localhost:8080/producer/msg?mp=eiffelsemantics

[{"id":"9cdd0f68-df85-44b0-88bd-fc4163ac90a0","statusCode":200,"result":"SUCCESS"}]
</code></pre>

<p><strong>Two messages/objects and given user domain suffix:</strong></p>

<pre><code>$ curl -H "Content-Type: application/json" -X POST -d '[{"data":{"outcome":{"conclusion":"TIMED_OUT","description":"Compilation timed out."},"persistentLogs":[{"name":"firstLog","uri":"http://myHost.com/firstLog"},{"name":"otherLog","uri":"isbn:0-486-27557-4"}]},"links":{"activityExecution":"aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeee1","flowContext":"flowContext","causes":["cause1","cause2"]},"meta":{"domainId":"example.domain","id":"9cdd0f68-df85-44b0-88bd-fc4163ac90a0","type":"eiffelactivityfinished","version":"0.1.7","time":1478780245184,"tags":["tag1","tag2"],"source":{"host":"host","name":"name","uri":"http://java.sun.com/j2se/1.3/","serializer":{"groupId":"G","artifactId":"A","version":"V"}}}},{"data":{"outcome":{"conclusion":"TIMED_OUT","description":"Compilation timed out."},"persistentLogs":[{"name":"firstLog","uri":"http://myHost.com/firstLog"},{"name":"otherLog","uri":"isbn:0-486-27557-4"}]},"links":{"activityExecution":"aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeee1","flowContext":"flowContext","causes":["cause1","cause2"]},"meta":{"domainId":"example.domain","id":"9cdd0f68-df85-44b0-88bd-fc4163ac90b1","type":"eiffelactivityfinished","version":"0.1.7","time":1478780245184,"tags":["tag1","tag2"],"source":{"host":"host","name":"name","uri":"http://java.sun.com/j2se/1.3/","serializer":{"groupId":"G","artifactId":"A","version":"V"}}}}]' http://localhost:8080/producer/msg?ud=fem001&mp=eiffelsemantics

[{"id":"9cdd0f68-df85-44b0-88bd-fc4163ac90a0","statusCode":200,"result":"SUCCESS"},{"id":"9cdd0f68-df85-44b0-88bd-fc4163ac90a1","statusCode":200,"result":"SUCCESS"}]
</code></pre>

<p><strong>Reading data from a file:</strong></p>

<pre><code>$ echo '[{"data":{"outcome":{"conclusion":"TIMED_OUT","description":"Compilation timed out."},"persistentLogs":[{"name":"firstLog","uri":"http://myHost.com/firstLog"},{"name":"otherLog","uri":"isbn:0-486-27557-4"}]},"links":{"activityExecution":"aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeee1","flowContext":"flowContext","causes":["cause1","cause2"]},"meta":{"domainId":"example.domain","id":"9cdd0f68-df85-44b0-88bd-fc4163ac90a0","type":"eiffelactivityfinished","version":"0.1.7","time":1478780245184,"tags":["tag1","tag2"],"source":{"host":"host","name":"name","uri":"http://java.sun.com/j2se/1.3/","serializer":{"groupId":"G","artifactId":"A","version":"V"}}}},{"data":{"outcome":{"conclusion":"TIMED_OUT","description":"Compilation timed out."},"persistentLogs":[{"name":"firstLog","uri":"http://myHost.com/firstLog"},{"name":"otherLog","uri":"isbn:0-486-27557-4"}]},"links":{"activityExecution":"aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeee1","flowContext":"flowContext","causes":["cause1","cause2"]},"meta":{"domainId":"example.domain","id":"9cdd0f68-df85-44b0-88bd-fc4163ac90b1","type":"eiffelactivityfinished","version":"0.1.7","time":1478780245184,"tags":["tag1","tag2"],"source":{"host":"host","name":"name","uri":"http://java.sun.com/j2se/1.3/","serializer":{"groupId":"G","artifactId":"A","version":"V"}}}}]' &gt; test.data
$ curl -H "Content-Type: application/json" -X POST --data-binary "@test.data" http://localhost:8080/producer/msg?mp=eiffelsemantics

[{"id":"9cdd0f68-df85-44b0-88bd-fc4163ac90a0","statusCode":200,"result":"SUCCESS"},{"id":"9cdd0f68-df85-44b0-88bd-fc4163ac90a1","statusCode":200,"result":"SUCCESS"}]
</code></pre>

<p><strong>Malformed input:</strong></p>

<pre><code>$ curl -H "Content-Type: application/json" -X POST -d 'SOMETHING' http://localhost:8080/producer/msg?ud=fem001&mp=eiffel3

{"timestamp":"May 31, 2016 9:14:17 AM","status":400,"error":"Bad Request","exception":"org.springframework.http.converter.HttpMessageNotReadableException","message":"Could not read JSON: Expected a com.google.gson.JsonArray but was com.google.gson.JsonPrimitive; nested exception is com.google.gson.JsonSyntaxException: Expected a com.google.gson.JsonArray but was com.google.gson.JsonPrimitive","path":"/producer/msg"}
</code></pre>

<p>You can open the RabbitMQ's management console and find these messages in a queue.</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Eiffel RemRem Publish Service maintained by <a href="https://github.com/evasiba-ericsson">evasiba-ericsson</a></p>
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
